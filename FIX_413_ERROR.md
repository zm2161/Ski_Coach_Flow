# 🔧 修复 413 错误 - 文件大小限制

## 问题描述

上传视频时遇到 `413 Request Entity Too Large` 错误。这是因为 nginx 反向代理（AI Builder/Koyeb 使用）限制了请求体大小。

## 错误原因

1. **nginx 默认限制**: nginx 的 `client_max_body_size` 默认通常是 1MB
2. **请求在到达 Express 之前被拒绝**: nginx 在请求到达应用之前就拒绝了
3. **无法直接配置 nginx**: 在 AI Builder/Koyeb 平台上，我们无法直接修改 nginx 配置

## 解决方案

### 已实施的修复

1. **降低文件大小限制**:
   - Express: `100MB` → `20MB`
   - Multer: `100MB` → `20MB`
   - 前端验证: `100MB` → `20MB`

2. **改进错误处理**:
   - 添加了 413 错误的专门处理
   - 提供更友好的错误消息
   - 在前端显示明确的文件大小限制提示

### 文件大小限制

- **最大文件大小**: 20MB
- **推荐大小**: < 15MB（留出安全余量）

## 用户提示

如果用户上传的文件超过 20MB，会看到：

```
文件大小必须小于 20MB。
当前文件大小: XX.XX MB

提示: 请压缩视频或使用更短的视频片段。
```

## 未来改进（可选）

如果需要支持更大的文件，可以考虑：

1. **分块上传 (Chunked Upload)**:
   - 将大文件分成多个小块上传
   - 在服务器端重新组装
   - 需要修改前端和后端代码

2. **直接上传到云存储**:
   - 使用 S3、Cloudflare R2 等
   - 前端直接上传到云存储
   - 后端只处理分析请求

3. **视频压缩**:
   - 在前端使用 Web API 压缩视频
   - 降低分辨率和比特率
   - 减少文件大小

## 测试建议

1. **测试小文件** (< 10MB): 应该正常工作
2. **测试中等文件** (10-20MB): 应该正常工作
3. **测试大文件** (> 20MB): 应该显示友好的错误消息

## 部署后

修复已提交到 GitHub，AI Builder 会自动重新部署。等待部署完成后，再次测试上传功能。

